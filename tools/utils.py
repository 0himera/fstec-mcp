"""–£—Ç–∏–ª–∏—Ç—ã –¥–ª—è MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ FSTEC."""
import os
from typing import Any, Dict, List, Optional
from dataclasses import dataclass

import pandas as pd
from mcp.types import TextContent


@dataclass
class ToolResult:
    """–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞."""
    content: List[TextContent]
    structured_content: Dict[str, Any]
    meta: Dict[str, Any]


def _require_env_vars(names: List[str]) -> Dict[str, str]:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.
    
    Args:
        names: –°–ø–∏—Å–æ–∫ –∏–º–µ–Ω –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
        
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
        
    Raises:
        McpError: –ï—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    """
    missing = [n for n in names if not os.getenv(n)]
    if missing:
        from mcp.shared.exceptions import McpError, ErrorData
        raise McpError(
            ErrorData(
                code=-32602,
                message="–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: " + ", ".join(missing)
            )
        )
    return {n: os.getenv(n, "") for n in names}


class FSTECDataLoader:
    """–ó–∞–≥—Ä—É–∑—á–∏–∫ –¥–∞–Ω–Ω—ã—Ö –§–°–¢–≠–ö –∏–∑ Excel —Ñ–∞–π–ª–∞."""
    
    _instance: Optional['FSTECDataLoader'] = None
    _df: Optional[pd.DataFrame] = None
    
    # –ú–∞–ø–ø–∏–Ω–≥ –∫–æ–ª–æ–Ω–æ–∫ Excel —Ñ–∞–π–ª–∞
    COLUMN_MAPPING = {
        0: '–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä',
        1: '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏',
        2: '–û–ø–∏—Å–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏',
        3: '–í–µ–Ω–¥–æ—Ä –ü–û',
        4: '–ù–∞–∑–≤–∞–Ω–∏–µ –ü–û',
        5: '–í–µ—Ä—Å–∏—è –ü–û',
        6: '–¢–∏–ø –ü–û',
        7: '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –û–°',
        8: '–ö–ª–∞—Å—Å —É—è–∑–≤–∏–º–æ—Å—Ç–∏',
        9: '–î–∞—Ç–∞ –≤—ã—è–≤–ª–µ–Ω–∏—è',
        10: 'CVSS 2.0',
        11: 'CVSS 3.0',
        12: 'CVSS 4.0',
        13: '–£—Ä–æ–≤–µ–Ω—å –æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–∏',
        14: '–í–æ–∑–º–æ–∂–Ω—ã–µ –º–µ—Ä—ã –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é',
        15: '–°—Ç–∞—Ç—É—Å —É—è–∑–≤–∏–º–æ—Å—Ç–∏',
        16: '–ù–∞–ª–∏—á–∏–µ —ç–∫—Å–ø–ª–æ–π—Ç–∞',
        17: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–∏',
        18: '–°—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏',
        19: '–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –¥—Ä—É–≥–∏—Ö —Å–∏—Å—Ç–µ–º',
        20: '–ü—Ä–æ—á–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
        21: '–°–≤—è–∑—å —Å –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞–º–∏ –ò–ë',
        22: '–°–ø–æ—Å–æ–± —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏',
        23: '–°–ø–æ—Å–æ–± —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è',
        24: '–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏',
        25: '–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è',
        26: '–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏',
        27: '–°–æ—Å—Ç–æ—è–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏',
        28: '–û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ CWE',
        29: '–¢–∏–ø –æ—à–∏–±–∫–∏ CWE',
    }
    
    @classmethod
    def get_instance(cls, file_path: str = "vullist.xlsx") -> 'FSTECDataLoader':
        """–ü–æ–ª—É—á–∏—Ç—å singleton —ç–∫–∑–µ–º–ø–ª—è—Ä –∑–∞–≥—Ä—É–∑—á–∏–∫–∞."""
        if cls._instance is None:
            cls._instance = cls()
            cls._instance._load_data(file_path)
        return cls._instance
    
    def _load_data(self, file_path: str) -> None:
        """
        –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Excel —Ñ–∞–π–ª–∞ –≤ –ø–∞–º—è—Ç—å.
        
        Args:
            file_path: –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É vullist.xlsx
            
        Raises:
            FileNotFoundError: –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω
        """
        if not os.path.exists(file_path):
            raise FileNotFoundError(
                f"‚ùå –§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –§–°–¢–≠–ö –Ω–µ –Ω–∞–π–¥–µ–Ω: {file_path}\n"
                "–°–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª —Å —Å–∞–π—Ç–∞ bdu.fstec.ru"
            )
        
        print(f"üìÇ –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –§–°–¢–≠–ö –∏–∑ {file_path}...")
        
        # –ß–∏—Ç–∞–µ–º Excel, –ø—Ä–æ–ø—É—Å–∫–∞—è –ø–µ—Ä–≤—ã–µ 3 —Å—Ç—Ä–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
        self._df = pd.read_excel(
            file_path, 
            engine='openpyxl', 
            header=None, 
            skiprows=3
        )
        
        # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –º–∞–ø–ø–∏–Ω–≥—É
        self._df.rename(columns=self.COLUMN_MAPPING, inplace=True)
        
        # –ó–∞–º–µ–Ω—è–µ–º NaN –Ω–∞ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
        self._df.fillna("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö", inplace=True)
        
        # –ü—Ä–∏–≤–æ–¥–∏–º –≤—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –∫ —Å—Ç—Ä–æ–∫–∞–º
        for col in self._df.columns:
            if self._df[col].dtype == 'object':
                self._df[col] = self._df[col].astype(str)
        
        print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(self._df)} –∑–∞–ø–∏—Å–µ–π –æ–± —É—è–∑–≤–∏–º–æ—Å—Ç—è—Ö")
    
    @property
    def dataframe(self) -> pd.DataFrame:
        """–ü–æ–ª—É—á–∏—Ç—å DataFrame —Å –¥–∞–Ω–Ω—ã–º–∏."""
        if self._df is None:
            raise RuntimeError("–î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –í—ã–∑–æ–≤–∏—Ç–µ get_instance() —Å–Ω–∞—á–∞–ª–∞.")
        return self._df
    
    def search(self, query: str, limit: int = 5) -> pd.DataFrame:
        """
        –ü–æ–∏—Å–∫ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º.
        –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: "nginx 1.5.6") - –∏—â–µ—Ç —Å—Ç—Ä–æ–∫–∏,
        –≥–¥–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –í–°–ï —Å–ª–æ–≤–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –≤ –ª—é–±—ã—Ö —Ü–µ–ª–µ–≤—ã—Ö –∫–æ–ª–æ–Ω–∫–∞—Ö.
        
        Args:
            query: –ü–æ–∏—Å–∫–æ–≤–∞—è —Ñ—Ä–∞–∑–∞
            limit: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            
        Returns:
            DataFrame —Å –Ω–∞–π–¥–µ–Ω–Ω—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏
        """
        df = self.dataframe
        # –†–∞–∑–±–∏–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ "AND" –ª–æ–≥–∏–∫–æ–π
        query_parts = query.lower().split()
        
        if not query_parts:
            return df.head(0)
            
        # –ö–æ–ª–æ–Ω–∫–∏, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –∏—â–µ–º
        search_columns = [
            '–ù–∞–∑–≤–∞–Ω–∏–µ –ü–û',
            '–û–ø–∏—Å–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏', 
            '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏',
            '–í–µ–Ω–¥–æ—Ä –ü–û',
            '–í–µ—Ä—Å–∏—è –ü–û'  # –î–æ–±–∞–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é –¥–ª—è –ø–æ–∏—Å–∫–∞
        ]
        
        # –ù–∞—á–∏–Ω–∞–µ–º —Å –º–∞—Å–∫–∏, –≥–¥–µ –≤—Å–µ True
        final_mask = pd.Series([True] * len(df), index=df.index)
        
        # –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª–æ–≤–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
        for part in query_parts:
            # –ú–∞—Å–∫–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å–ª–æ–≤–∞ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ö–æ—Ç—è –±—ã –≤ –æ–¥–Ω–æ–π –∫–æ–ª–æ–Ω–∫–µ)
            part_mask = pd.Series([False] * len(df), index=df.index)
            
            for col in search_columns:
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º regex=False –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤ (—Ç–æ—á–∫–∏ –≤ –≤–µ—Ä—Å–∏—è—Ö –∏ —Ç.–¥.)
                part_mask |= df[col].str.lower().str.contains(part, regex=False, na=False)
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é –º–∞—Å–∫—É (–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –ò)
            final_mask &= part_mask
        
        results = df[final_mask].head(limit)
        return results
    
    def get_by_id(self, bdu_id: str) -> Optional[pd.Series]:
        """
        –ü–æ–ª—É—á–∏—Ç—å —É—è–∑–≤–∏–º–æ—Å—Ç—å –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É BDU.
        
        Args:
            bdu_id: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—è–∑–≤–∏–º–æ—Å—Ç–∏ (—Ñ–æ—Ä–º–∞—Ç: BDU:20xx-xxxxx)
            
        Returns:
            Series —Å –¥–∞–Ω–Ω—ã–º–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –∏–ª–∏ None
        """
        df = self.dataframe
        mask = df['–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä'] == bdu_id
        results = df[mask]
        
        if results.empty:
            return None
        
        return results.iloc[0]
