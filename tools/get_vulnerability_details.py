"""–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –§–°–¢–≠–ö."""
from fastmcp import Context
from mcp.types import TextContent
from opentelemetry import trace
from pydantic import Field

from mcp_instance import mcp
from .utils import ToolResult, FSTECDataLoader

# OpenTelemetry tracer
tracer = trace.get_tracer(__name__)


@mcp.tool(
    name="get_vulnerability_details",
    description="""üìã –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É BDU.

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏, –º–µ—Ä—ã –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é, —Å–ø–∏—Å–æ–∫ —É—è–∑–≤–∏–º–æ–≥–æ –ü–û –∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏.

–§–æ—Ä–º–∞—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞: BDU:20xx-xxxxx (–Ω–∞–ø—Ä–∏–º–µ—Ä: BDU:2024-12345)
"""
)
async def get_vulnerability_details(
    bdu_id: str = Field(
        ...,
        description="–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—è–∑–≤–∏–º–æ—Å—Ç–∏ (—Ñ–æ—Ä–º–∞—Ç: BDU:20xx-xxxxx, –Ω–∞–ø—Ä–∏–º–µ—Ä: BDU:2024-12345)"
    ),
    ctx: Context = None
) -> ToolResult:
    """
    üìã –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É ID —É—è–∑–≤–∏–º–æ—Å—Ç–∏.
    
    –í—ã–ø–æ–ª–Ω—è–µ—Ç —Ç–æ—á–Ω—ã–π –ø–æ–∏—Å–∫ –∑–∞–ø–∏—Å–∏, –≥–¥–µ –∫–æ–ª–æ–Ω–∫–∞ "–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä" —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å bdu_id.
    
    Args:
        bdu_id: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—è–∑–≤–∏–º–æ—Å—Ç–∏ (—Ñ–æ—Ä–º–∞—Ç: BDU:20xx-xxxxx)
        ctx: –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        
    Returns:
        ToolResult: –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –æ–ø–∏—Å–∞–Ω–∏—è, –º–µ—Ä—ã –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é, —Å–ø–∏—Å–æ–∫ —É—è–∑–≤–∏–º–æ–≥–æ –ü–û –∏ —Å—Å—ã–ª–∫–∏
        
    Examples:
        >>> result = await get_vulnerability_details("BDU:2024-12345", ctx)
        >>> print(result.content)
    """
    with tracer.start_as_current_span("get_vulnerability_details") as span:
        span.set_attribute("bdu_id", bdu_id)
        
        await ctx.info(f"üìã –ü–æ–∏—Å–∫ —É—è–∑–≤–∏–º–æ—Å—Ç–∏: {bdu_id}")
        await ctx.report_progress(progress=0, total=100)
        
        try:
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–µ—à–∞
            loader = FSTECDataLoader.get_instance()
            await ctx.report_progress(progress=25, total=100)
            
            # –ò—â–µ–º –ø–æ ID
            await ctx.info("üîç –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫ –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É...")
            vuln = loader.get_by_id(bdu_id)
            await ctx.report_progress(progress=75, total=100)
            
            if vuln is None:
                await ctx.info(f"‚ö†Ô∏è –£—è–∑–≤–∏–º–æ—Å—Ç—å {bdu_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
                span.set_attribute("found", False)
                
                return ToolResult(
                    content=[TextContent(
                        type="text",
                        text=f"–£—è–∑–≤–∏–º–æ—Å—Ç—å —Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º '{bdu_id}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ –§–°–¢–≠–ö.\n"
                             f"–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ñ–æ—Ä–º–∞—Ç–∞: BDU:20xx-xxxxx"
                    )],
                    structured_content={"bdu_id": bdu_id, "found": False},
                    meta={"bdu_id": bdu_id}
                )
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
            details = {
                "id": str(vuln['–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä']),
                "name": str(vuln['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏']),
                "description": str(vuln['–û–ø–∏—Å–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏']),
                "vendor": str(vuln['–í–µ–Ω–¥–æ—Ä –ü–û']),
                "software": str(vuln['–ù–∞–∑–≤–∞–Ω–∏–µ –ü–û']),
                "version": str(vuln['–í–µ—Ä—Å–∏—è –ü–û']),
                "software_type": str(vuln['–¢–∏–ø –ü–û']),
                "os": str(vuln['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –û–°']),
                "vulnerability_class": str(vuln['–ö–ª–∞—Å—Å —É—è–∑–≤–∏–º–æ—Å—Ç–∏']),
                "detection_date": str(vuln['–î–∞—Ç–∞ –≤—ã—è–≤–ª–µ–Ω–∏—è']),
                "cvss_2": str(vuln['CVSS 2.0']),
                "cvss_3": str(vuln['CVSS 3.0']),
                "cvss_4": str(vuln['CVSS 4.0']),
                "severity": str(vuln['–£—Ä–æ–≤–µ–Ω—å –æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–∏']),
                "remediation": str(vuln['–í–æ–∑–º–æ–∂–Ω—ã–µ –º–µ—Ä—ã –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é']),
                "status": str(vuln['–°—Ç–∞—Ç—É—Å —É—è–∑–≤–∏–º–æ—Å—Ç–∏']),
                "exploit_available": str(vuln['–ù–∞–ª–∏—á–∏–µ —ç–∫—Å–ø–ª–æ–π—Ç–∞']),
                "fix_info": str(vuln['–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–∏']),
                "references": str(vuln['–°—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏']),
                "other_ids": str(vuln['–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –¥—Ä—É–≥–∏—Ö —Å–∏—Å—Ç–µ–º']),
                "exploitation_method": str(vuln['–°–ø–æ—Å–æ–± —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏']),
                "fix_method": str(vuln['–°–ø–æ—Å–æ–± —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è']),
                "publication_date": str(vuln['–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏']),
                "last_update": str(vuln['–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è']),
                "consequences": str(vuln['–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏']),
                "state": str(vuln['–°–æ—Å—Ç–æ—è–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏']),
                "cwe_description": str(vuln['–û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ CWE']),
                "cwe_type": str(vuln['–¢–∏–ø –æ—à–∏–±–∫–∏ CWE']),
            }
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤—ã–≤–æ–¥
            text_output = f"""
üìã **{details['id']}**

## –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
{details['name']}

## –û–ø–∏—Å–∞–Ω–∏–µ
{details['description']}

## –£—è–∑–≤–∏–º–æ–µ –ü–û
- **–í–µ–Ω–¥–æ—Ä:** {details['vendor']}
- **–ù–∞–∑–≤–∞–Ω–∏–µ –ü–û:** {details['software']}
- **–í–µ—Ä—Å–∏—è:** {details['version']}
- **–¢–∏–ø –ü–û:** {details['software_type']}
- **–û–°/–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:** {details['os']}

## –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
- **–ö–ª–∞—Å—Å —É—è–∑–≤–∏–º–æ—Å—Ç–∏:** {details['vulnerability_class']}
- **–î–∞—Ç–∞ –≤—ã—è–≤–ª–µ–Ω–∏—è:** {details['detection_date']}
- **–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:** {details['publication_date']}
- **–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** {details['last_update']}

## –û—Ü–µ–Ω–∫–∞ –æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- **–£—Ä–æ–≤–µ–Ω—å –æ–ø–∞—Å–Ω–æ—Å—Ç–∏:** {details['severity']}
- **CVSS 2.0:** {details['cvss_2']}
- **CVSS 3.0:** {details['cvss_3']}
- **CVSS 4.0:** {details['cvss_4']}

## CWE
- **–¢–∏–ø –æ—à–∏–±–∫–∏:** {details['cwe_type']}
- **–û–ø–∏—Å–∞–Ω–∏–µ:** {details['cwe_description']}

## –≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è
- **–ù–∞–ª–∏—á–∏–µ —ç–∫—Å–ø–ª–æ–π—Ç–∞:** {details['exploit_available']}
- **–°–ø–æ—Å–æ–± —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏:** {details['exploitation_method']}
- **–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:** {details['consequences']}

## –ú–µ—Ä—ã –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é
{details['remediation']}

- **–°–ø–æ—Å–æ–± —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è:** {details['fix_method']}
- **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–∏:** {details['fix_info']}

## –°—Ç–∞—Ç—É—Å
- **–°—Ç–∞—Ç—É—Å —É—è–∑–≤–∏–º–æ—Å—Ç–∏:** {details['status']}
- **–°–æ—Å—Ç–æ—è–Ω–∏–µ:** {details['state']}

## –°—Å—ã–ª–∫–∏
{details['references']}

## –î—Ä—É–≥–∏–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
{details['other_ids']}
"""
            
            await ctx.report_progress(progress=100, total=100)
            await ctx.info(f"‚úÖ –ù–∞–π–¥–µ–Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç—å: {bdu_id}")
            
            span.set_attribute("found", True)
            span.set_attribute("severity", details['severity'])
            span.set_attribute("success", True)
            
            return ToolResult(
                content=[TextContent(type="text", text=text_output.strip())],
                structured_content=details,
                meta={"bdu_id": bdu_id}
            )
            
        except FileNotFoundError as e:
            span.set_attribute("error", "file_not_found")
            await ctx.error(f"‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {e}")
            
            from mcp.shared.exceptions import McpError, ErrorData
            raise McpError(
                ErrorData(
                    code=-32603,
                    message=str(e)
                )
            )
        except Exception as e:
            span.set_attribute("error", str(e))
            await ctx.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: {e}")
            
            from mcp.shared.exceptions import McpError, ErrorData
            raise McpError(
                ErrorData(
                    code=-32603,
                    message=f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ–± —É—è–∑–≤–∏–º–æ—Å—Ç–∏: {e}"
                )
            )
